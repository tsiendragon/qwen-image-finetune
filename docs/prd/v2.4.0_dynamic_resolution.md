# Dynamic Resolution (v2.4.0) — PRD（简化版）

目标：在不改变现有训练逻辑的前提下，允许在固定“分辨率池”内为样本动态选择分辨率；仅在配置与预处理层做极小变更；不引入宽高比或像素等效的复杂策略；文档≤300行。

## 1. 背景与问题
- 当前训练要求统一尺寸（如 512x512），导致：
  - 预处理需裁剪或填充，可能损失信息。
  - 数据多样性受限。
注意到 训练 diffuser 的过程中，如果 `number of pixels` 是固定的话，它转化为 vae  latent 的时候 sequence length 就是一样的，这样就可以进行 batch inference.
那我么可以把固定的 shape 转化为固定的 number of pixels,从而能支持动态的shape输入

## 3. 设计概览
- 新增开关 `fixed_pixels`，默认 false（完全保持旧行为）。
- 新增参数 `controls_pixels` 表示 不同的 control image 的像素量
- 新增参数 `target_pixels` 表示生成的图片的像素总量， 如果target_size 仍然存在，则表示生成的图片是一个固定的尺寸，如果target_pixels 和 如果target_size 都为空的话，则表示生成的图片尺寸和第一个 control 图片的尺寸相同
- 预处理阶段按策略为样本选择目标分辨率，后续流程（resize/crop/padding、to_tensor、controls 处理）不变。如果是fixed_pixels, 则 resize H,W 使得 HxW = number_of_pixels
- 在 `img_shapes` 需要在 cache 中计算并保存。从同一个 batch 里的 img_shapes 相同改为不同。其余的 image_latents, control_latents, prompt_embeds, prompt_embeds_mask 都可以正常使用
- 在 predict 中也使用相同的策略。 predict 是 batch_size=1, 能支持这个功能
- for `fixed_pixels` mode, only in qwen-image-edit trainer, and cache mode

## 4. 配置 Schema（最小新增）
```yaml
data:
  init_args:
    processor:
      class_path: "src.data.preprocess.ImageProcessor"
      init_args:
        # 现有字段（保持不变）
        process_type: "fixed_pixels"
        resize_mode: "bilinear"
        # target_size: [512, 512]
        target_pixels: 512*512  # 如果target_pixels
        # controls_size: [[512,512], [256,512]]
        controls_pixels: [512*512, 256*512]  # 表示不同的control image 的 target number of pixels
        ...

```
