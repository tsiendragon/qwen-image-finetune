# v3.2.1 Release Notes

## Overview

Version 3.2.1 fixes critical bugs related to scheduler state management during validation and directory cleanup operations. These fixes ensure training stability and prevent state pollution between training and validation phases.

## Bug Fixes

### Scheduler State Isolation

**Issue**: Validation sampling and training were sharing the same scheduler instance, causing state pollution. When validation called `set_timesteps()` during sampling, it modified the scheduler's `timesteps` property, which affected subsequent training steps that relied on `scheduler.timesteps[indices]`.

**Fix**: Created separate scheduler instances for training and validation/sampling:
- `self.scheduler`: Used exclusively for training steps
- `self.sampling_scheduler`: Used exclusively for validation sampling and inference

**Impact**:
- Ensures training stability by preventing scheduler state modifications during validation
- Validation operations no longer affect training timestep calculations
- Both schedulers are initialized from the same configuration via deepcopy

**Files Modified**:
- `src/qflux/trainer/base_trainer.py`: Added `sampling_scheduler` attribute and updated `prepare_predict_timesteps()` to accept scheduler parameter
- `src/qflux/trainer/flux_kontext_trainer.py`: Create independent schedulers, use `sampling_scheduler` in `sampling_from_embeddings()` and `sampling_from_embeddings_multi_resolution()`
- `src/qflux/trainer/qwen_image_edit_trainer.py`: Create independent schedulers, use `sampling_scheduler` in `sampling_from_embeddings()`

### Directory Cleanup Fix

**Issue**: When cleaning up invalid training versions (with < 5 training steps), the code deleted entire version directories, which could cause issues if the directory structure was needed or expected to exist.

**Fix**: Modified cleanup logic to only remove contents within invalid version directories, preserving the directory structure itself.

**Impact**:
- Preserves directory structure for version management
- Allows reuse of empty version directories
- More robust cleanup behavior

**Files Modified**:
- `src/qflux/trainer/base_trainer.py`: Updated `setup_versioned_logging_dir()` to remove directory contents instead of deleting entire directories

## Technical Details

### Scheduler Isolation Implementation

```python
# In load_model():
self.scheduler = load_flux_kontext_scheduler(...)
import copy
self.sampling_scheduler = copy.deepcopy(self.scheduler)

# In sampling_from_embeddings():
timesteps, num_inference_steps = self.prepare_predict_timesteps(
    num_inference_steps, image_seq_len, scheduler=self.sampling_scheduler
)
self.sampling_scheduler.set_begin_index(0)
# ... use sampling_scheduler.step() ...
```

### Directory Cleanup Improvement

```python
# Before: shutil.rmtree(version_path)
# After:
for item in os.listdir(version_path):
    item_path = os.path.join(version_path, item)
    if os.path.isdir(item_path):
        shutil.rmtree(item_path)
    else:
        os.remove(item_path)
```

## Migration Notes

- **No configuration changes required**: The fix is transparent to users
- **Backward compatible**: Existing training scripts continue to work without modification
- **Validation behavior unchanged**: Validation still runs at the same intervals and produces the same results

## Testing

- Verified that training steps use `self.scheduler` consistently
- Verified that validation sampling uses `self.sampling_scheduler` exclusively
- Confirmed that scheduler state modifications during validation do not affect training
- Tested directory cleanup preserves directory structure

## Related Issues

- Fixed scheduler state pollution between training and validation
- Fixed directory cleanup removing entire directories instead of contents
